<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <!-- Include React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Include Babel for JSX support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Include Bulma 1.0.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <style>
        #chat-box { 
            height: 65vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message-right {
            text-align: right;
			padding: 5px;
        }
		.container {
			width: 40vw;
			word-wrap: break-word;
		}

		@media (max-width: 768px) {
			.container {
				width: 95vw;
			}
		}
    </style>
    <script type="text/babel">
	
	const { useState, useEffect, useRef } = React;

	const ChatClient = () => {
		const [messages, setMessages] = useState([]);
		const [username, setUsername] = useState("Anonymous");
		const [currentMessage, setCurrentMessage] = useState("");
		const [currentName, setCurrentName] = useState("");
		const [typingUsers, setTypingUsers] = useState(new Set()); // Track typing users
		const ws = useRef(null);
		const chatBoxRef = useRef(null);
		const typingTimeout = useRef(null);  // Initialize typing timeout as a ref

		// Initialize WebSocket connection
		useEffect(() => {
			ws.current = new WebSocket("ws://192.168.2.4:18080/chat");

			ws.current.onopen = () => {
				addSystemMessage("Connected to the chat server.");
			};

			ws.current.onmessage = (event) => {
				if (event.data.endsWith("is typing...")) {
					// Add typing user to the set
					setTypingUsers((prev) => new Set(prev).add(event.data.replace(" is typing...", "")));
				} else if (event.data.endsWith("stopped typing.")) {
					// Remove stopped typing user from the set
					setTypingUsers((prev) => {
						const newSet = new Set(prev);
						newSet.delete(event.data.replace(" stopped typing.", ""));
						return newSet;
					});
				} else {
					addMessage(event.data);
				}
			};

			ws.current.onclose = () => {
				addSystemMessage("Disconnected from the chat server.");
			};

			return () => {
				ws.current.close();
			};
		}, []);

		// Add a system message (like connection updates)
		const addSystemMessage = (text) => {
			setMessages((prev) => [...prev, { type: "system", text }]);
		};

		// Add a regular chat message
		const addMessage = (text) => {
			setMessages((prev) => [...prev, { type: "chat", text }]);
		};

		// Handle sending a message
		const sendMessage = () => {
			if (currentMessage.trim()) {
				addMessage(`${username}: ${currentMessage}`);
				ws.current.send(currentMessage);
				setCurrentMessage("");
			}
		};

		// Handle setting the username
		const updateUsername = () => {
			if (currentName.trim()) {
				ws.current.send(`/name ${currentName}`);
				setUsername(currentName);
				addSystemMessage(`You are now known as ${currentName}`);
				setCurrentName("");
			}
		};

		// Handle typing notification (do not store in history)
		const handleTyping = (e) => {
			setCurrentMessage(e.target.value);

			// If no one is currently typing, show the typing notification
			if (!typingUsers.has(username)) {
				ws.current.send("/typing");  // Notify others that the user is typing
			}

			// Reset the typing timeout to hide the typing notification after inactivity
			clearTimeout(typingTimeout.current);  // Clear the previous timeout
			typingTimeout.current = setTimeout(() => {
				ws.current.send("/stopped");  // Notify others that typing has stopped
			}, 1000);  // Typing stops after 1 second of inactivity
		};

		// Scroll chat box to bottom when messages change
		useEffect(() => {
			if (chatBoxRef.current) {
				chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
			}
		}, [messages]);

		// Render messages in the chat
		const renderMessages = () =>
			messages.map((msg, index) => {
				if (msg.type === "system") {
					return (
						<div key={index} className="has-text-grey-light is-italic mb-2">
							{msg.text}
						</div>
					);
				}
				const isSender = msg.text.startsWith(username);
				return (
					<div key={index} className={`message ${isSender ? 'message-right' : ''}`}>
						{msg.text}
					</div>
				);
			});

		return (
			<div className="container mt-5">
				<h1 className="title is-3 has-text-centered mb-4">WebSocket Chat</h1>

				<div className="box">
					<div id="chat-box" ref={chatBoxRef}>
						{renderMessages()}
						{/* Display typing notification (only temporarily) */}
						{Array.from(typingUsers).map((user) => (
							user !== username && (
								<div key={user} className="has-text-grey-light is-italic mb-2">
									{user} is typing...
								</div>
							)
						))}
					</div>
				</div>

				<div className="field has-addons mb-3 mt-3">
					<div className="control is-expanded">
						<input
							type="text"
							className="input"
							placeholder="Enter your username"
							value={currentName}
							onChange={(e) => setCurrentName(e.target.value)}
						/>
					</div>
					<div className="control">
						<button className="button is-primary" onClick={updateUsername}>
							Set Username
						</button>
					</div>
				</div>

				<div className="field has-addons">
					<div className="control is-expanded">
						<input
							type="text"
							className="input"
							placeholder="Type a message"
							value={currentMessage}
							onChange={handleTyping}
							onKeyPress={(e) => e.key === "Enter" && sendMessage()}
						/>
					</div>
					<div className="control">
						<button className="button is-success" onClick={sendMessage}>
							Send
						</button>
					</div>
				</div>
			</div>
		);
	};

	ReactDOM.createRoot(document.getElementById("root")).render(<ChatClient />);

    </script>
</body>
</html>
